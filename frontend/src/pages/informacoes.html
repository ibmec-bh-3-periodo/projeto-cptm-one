<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Document</title>
<link rel="stylesheet" href="/css/informacoes.css">
<style>
  .popup {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;
  }
  .popup-content {
    background: #fff; padding: 30px; border-radius: 10px; min-width: 300px; text-align: center; position: relative;
  }
  .loading-bar {
    width: 100%; background: #eee; height: 20px; border-radius: 10px; margin: 20px 0;
  }
  .loading-progress {
    height: 100%; width: 0%; background: #009CA6; border-radius: 10px; transition: width 0.3s;
  }
</style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="logo"><a href="/pages/home.html"><img src="/images/imghome/logo.png" alt=""></a></div>
      <div class="settings"><img src="/images/imghome/configuracao (1).png" alt=""></div>
    </header>
    <div class="tudo">
      <section>
        <h1>SISTEMA DE INTERVALOS</h1>
        <p>Selecione a linha e confira os intervalos médios programados entre os trens.</p>
      </section>
      <main>
        <div class="linha" style="background-color: #A50034;">7 <span>Rubi</span></div>
        <div class="linha" style="background-color: #009CA6;">10 <span>Turquesa</span></div>
        <div class="linha" style="background-color: #F58220;">11 <span>Coral</span></div>
        <div class="linha" style="background-color: #002776;">12 <span>Safira</span></div>
        <div class="linha" style="background-color: #00A859;">13 <span>Jade</span></div>
        <div class="linha" style="background-color: #000000;">710 <span>Serviço</span></div>
      </main>
    </div>
    <div class="infobaixo">
      <p>A CPTM mantém as estações em funcionamento de todos os dias da semana, das 4h à meia-noite.</p>
      <p>A transferência entre linhas é garantida desde que o passageiro esteja em sua última estação de transferência até a 0h.</p>
      <p>O intervalo máximo entre trens aos fins de semana e feriados é de 35 minutos.</p>
    </div>

    <!-- Principal -->
    <section class="info"></section>
    <div class="espacar"></div>

    <!-- Bottom Navigation -->
    <footer>
      <a href="/pages/pagamento.html">
        <div class="saldo">
        <img src="/images/imghome/compras (2).png" alt="">
        </div>
      </a>
      <a href="/pages/home.html">
        <div class="home">
        <img src="/images/imghome/casa (3).png" alt="">
        </div>
      </a>  
      <a href="/pages/perfil.html">
        <div class="perfil">
        <img src="/images/imghome/solteiro (2).png" alt="">
        </div>
      </a>
    </footer>
  </div>

  <!-- Popup dentro do body -->
  <div id="popup" class="popup" style="display:none;">
    <div class="popup-content">
    <span id="close-popup" style="cursor:pointer;float:right;font-size:24px;">&times;</span>
    <h2 id="popup-title"></h2>
    <div class="loading-bar">
      <div class="loading-progress" id="loading-progress"></div>
    </div>
    <p id="popup-message"></p>
    </div>
  </div>

<!-- Adicione/ajuste este script no final do seu arquivo HTML -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Dados completos das linhas Jade e Safira
  const linhas = {
    Jade: {
      nome: "Linha 13 - Jade",
      intervalos: {
        dias_uteis: [
          { horario: "04:00 - 04:20", intervalo_minutos: 20 },
          { horario: "04:20 - 24:00", intervalo_minutos: 15 }
        ],
        sabados: [
          { horario: "04:00 - 04:20", intervalo_minutos: 20 },
          { horario: "04:20 - 20:00", intervalo_minutos: 15 },
          { horario: "20:00 - 24:00", intervalo_minutos: 35 }
        ],
        domingos_feriados: [
          { horario: "04:00 - 24:00", intervalo_minutos: 35 }
        ]
      }
    },
    Safira: {
      nome: "Linha 12 - Safira",
      intervalos: {
        dias_uteis: [
          { horario: "04:00 - 04:30", intervalo_minutos: 10 },
          { horario: "04:30 - 08:30", intervalo_minutos: 10 },
          { horario: "08:30 - 16:00", intervalo_minutos: 8 },
          { horario: "16:00 - 20:00", intervalo_minutos: 10 },
          { horario: "20:00 - 24:00", intervalo_minutos: 10 }
        ],
        sabados: [
          { horario: "04:00 - 18:00", intervalo_minutos: 8 },
          { horario: "18:00 - 20:00", intervalo_minutos: 10 },
          { horario: "20:00 - 24:00", intervalo_minutos: 35 }
        ],
        domingos_feriados: [
          { horario: "04:00 - 24:00", intervalo_minutos: 35 }
        ]
      }
    }
  };

  function getMinutos(horaStr) {
    // "06:15" => 375
    const [h, m] = horaStr.split(':').map(Number);
    return h * 60 + m;
  }

  function getTipoDia() {
    const hoje = new Date();
    const dia = hoje.getDay();
    if (dia === 0) return 'domingos_feriados';
    if (dia === 6) return 'sabados';
    return 'dias_uteis';
  }

  function getPeriodoAtual(intervalos, agoraMin) {
    for (const item of intervalos) {
      const [ini, fim] = item.horario.split(' - ');
      const iniMin = getMinutos(ini);
      const fimMin = getMinutos(fim);
      if (agoraMin >= iniMin && agoraMin < fimMin) {
        return { ...item, iniMin, fimMin };
      }
    }
    return null;
  }

  function getMinutosParaProximoTrem(intervaloMin, agoraMin, inicioMin) {
    // O primeiro trem parte em inicioMin, depois a cada intervaloMin
    if (agoraMin < inicioMin) return inicioMin - agoraMin;
    const minutosDesdeInicio = agoraMin - inicioMin;
    const minutosPassados = minutosDesdeInicio % intervaloMin;
    return minutosPassados === 0 ? 0 : intervaloMin - minutosPassados;
  }

  let popupInterval = null;

  document.querySelectorAll('.linha').forEach(div => {
    div.addEventListener('click', function() {
      const nomeLinha = this.querySelector('span').innerText.trim();
      let minutosParaProximo = 3; // padrão
      let intervaloMin = null;
      let inicioMin = null;
      let foraHorario = false;
      let periodo = null;

      if (nomeLinha === 'Jade' || nomeLinha === 'Safira') {
        const agora = new Date();
        const agoraMin = agora.getHours() * 60 + agora.getMinutes();
        const tipoDia = getTipoDia();
        const dadosLinha = linhas[nomeLinha];
        const intervalos = dadosLinha.intervalos[tipoDia];

        periodo = getPeriodoAtual(intervalos, agoraMin);

        if (periodo) {
          intervaloMin = Number(periodo.intervalo_minutos);
          inicioMin = periodo.iniMin;
          minutosParaProximo = getMinutosParaProximoTrem(intervaloMin, agoraMin, inicioMin);
        } else {
          foraHorario = true;
          minutosParaProximo = '-';
        }
      }

      document.getElementById('popup').style.display = 'flex';
      document.getElementById('popup-title').innerText = `Linha ${this.innerText.trim()}`;
      document.getElementById('popup-message').innerText = '';
      const loading = document.getElementById('loading-progress');
      loading.style.width = '0%';

      // Limpa qualquer intervalo anterior
      if (popupInterval) clearInterval(popupInterval);

      if (foraHorario) {
        loading.style.width = '100%';
        document.getElementById('popup-message').innerText = `Fora do horário de operação.`;
        return;
      }

      if (typeof minutosParaProximo !== 'number' || minutosParaProximo < 0) {
        loading.style.width = '100%';
        document.getElementById('popup-message').innerText = `Fora do horário de operação.`;
        return;
      }

      let minutosRestantes = minutosParaProximo;
      let totalMinutos = minutosParaProximo === 0 ? intervaloMin : minutosParaProximo;
      let progress = 0;

      function updatePopup() {
        const agora = new Date();
        const agoraMin = agora.getHours() * 60 + agora.getMinutes();

        // Recalcula o período e intervalo, caso mude de faixa de horário
        if (nomeLinha === 'Jade' || nomeLinha === 'Safira') {
          const tipoDia = getTipoDia();
          const dadosLinha = linhas[nomeLinha];
          const intervalos = dadosLinha.intervalos[tipoDia];
          periodo = getPeriodoAtual(intervalos, agoraMin);

          if (periodo) {
            intervaloMin = Number(periodo.intervalo_minutos);
            inicioMin = periodo.iniMin;
            minutosRestantes = getMinutosParaProximoTrem(intervaloMin, agoraMin, inicioMin);
            totalMinutos = intervaloMin;
          } else {
            foraHorario = true;
            minutosRestantes = '-';
          }
        }

        if (foraHorario || typeof minutosRestantes !== 'number' || minutosRestantes < 0) {
          loading.style.width = '100%';
          document.getElementById('popup-message').innerText = `Fora do horário de operação.`;
          clearInterval(popupInterval);
          return;
        }

        progress = 100 - Math.round((minutosRestantes / totalMinutos) * 100);
        loading.style.width = progress + '%';

        if (minutosRestantes > 0) {
          document.getElementById('popup-message').innerText =
            `Próximo trem chega em ${minutosRestantes} minuto${minutosRestantes > 1 ? 's' : ''}!`;
        } else {
          document.getElementById('popup-message').innerText = `Próximo trem chegou!`;
          loading.style.width = '100%';
        }
      }

      updatePopup();

      popupInterval = setInterval(function() {
        if (foraHorario) {
          clearInterval(popupInterval);
          return;
        }
        if (typeof minutosRestantes === 'number' && minutosRestantes > 0) {
          minutosRestantes--;
          progress = 100 - Math.round((minutosRestantes / totalMinutos) * 100);
          loading.style.width = progress + '%';
          if (minutosRestantes > 0) {
            document.getElementById('popup-message').innerText =
              `Próximo trem chega em ${minutosRestantes} minuto${minutosRestantes > 1 ? 's' : ''}!`;
          } else {
            document.getElementById('popup-message').innerText = `Próximo trem chegou!`;
            loading.style.width = '100%';
            clearInterval(popupInterval);
          }
        } else {
          clearInterval(popupInterval);
        }
      }, 60000); // 1 minuto

    });
  });

  document.getElementById('close-popup').onclick = function() {
    document.getElementById('popup').style.display = 'none';
    document.getElementById('loading-progress').style.width = '0%';
    document.getElementById('popup-message').innerText = '';
    if (popupInterval) clearInterval(popupInterval);
  };
});
</script>
</body>
</html>